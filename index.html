<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TradeJournal Pro</title>
    
    <!-- 1. Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- 2. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              slate: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' },
              primary: { 50: '#eef2ff', 100: '#e0e7ff', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
              // Enforcing exact chart colors for Green/Red consistency
              success: { 
                50: '#ecfdf5', 
                100: '#d1fae5', 
                400: '#34d399', // The Chart Green
                500: '#34d399', // Main Green Text/Bg
                600: '#059669', 
                700: '#047857' 
              },
              danger: { 
                50: '#fef2f2', 
                100: '#fee2e2', 
                400: '#f87171', // The Chart Red
                500: '#f87171', // Main Red Text/Bg
                600: '#dc2626', 
                700: '#b91c1c' 
              }
            },
            fontFamily: {
              sans: ['Roboto', 'sans-serif'],
            }
          }
        }
      }
    </script>

    <!-- 3. React & Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Fixed Recharts Version for Stability -->
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        font-family: 'Roboto', sans-serif;
        background-color: #f8fafc;
        color: #334155;
      }
      /* Custom Scrollbar */
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0",
    "recharts": "https://aistudiocdn.com/recharts@^3.4.1"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <!-- Application Logic -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        // Explicitly grab Recharts from window to avoid ReferenceError
        const { 
            LineChart, Line, AreaChart, Area, XAxis, YAxis, CartesianGrid, 
            Tooltip, ResponsiveContainer, PieChart, Pie, Cell, BarChart, Bar 
        } = window.Recharts;
        
        // Lucide Icons Wrapper
        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => { 
                if(window.lucide) window.lucide.createIcons(); 
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        };
        const PlusCircle = (props) => <Icon name="plus-circle" {...props} />;
        const ArrowUpRight = (props) => <Icon name="arrow-up-right" {...props} />;
        const ArrowDownRight = (props) => <Icon name="arrow-down-right" {...props} />;
        const ChevronLeft = (props) => <Icon name="chevron-left" {...props} />;
        const ChevronRight = (props) => <Icon name="chevron-right" {...props} />;
        const X = (props) => <Icon name="x" {...props} />;
        const Save = (props) => <Icon name="save" {...props} />;
        const Trash2 = (props) => <Icon name="trash-2" {...props} />;
        const Pencil = (props) => <Icon name="pencil" {...props} />;
        const Plus = (props) => <Icon name="plus" {...props} />;

        // Constants - Exact Colors
        const CHART_GREEN = '#34d399';
        const CHART_RED = '#f87171';

        // --- Services ---
        const STORAGE_KEY = 'trade_journal_data_v1';
        const saveTrades = (trades) => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(trades)); } catch (e) {} };
        const loadTrades = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; } };

        const calculateStats = (trades) => {
            if (trades.length === 0) return { totalPnl: 0, winRate: 0, profitFactor: 0, avgDailyProfit: 0, maxDrawdown: 0, totalTrades: 0 };
            
            let totalPnl = 0, grossProfit = 0, grossLoss = 0, wins = 0;
            const sorted = [...trades].sort((a, b) => a.timestamp - b.timestamp);
            const dailyPnl = {};

            sorted.forEach(t => {
                totalPnl += t.pnl;
                if (t.pnl > 0) { grossProfit += t.pnl; wins++; }
                else if (t.pnl < 0) { grossLoss += Math.abs(t.pnl); }
                dailyPnl[t.date] = (dailyPnl[t.date] || 0) + t.pnl;
            });

            const profitFactor = grossLoss === 0 ? grossProfit : grossProfit / grossLoss;
            const winRate = (wins / trades.length) * 100;
            const days = Object.keys(dailyPnl).length;
            const avgDailyProfit = days > 0 ? totalPnl / days : 0;

            let peak = 0, maxDD = 0, equity = 10000; 
            if(sorted[0] && sorted[0].pnlPercent !== 0) equity = Math.abs((sorted[0].pnl / sorted[0].pnlPercent) * 100);
            peak = equity;
            
            sorted.forEach(t => {
                equity += t.pnl;
                if (equity > peak) peak = equity;
                const dd = (peak - equity) / peak;
                if (dd > maxDD) maxDD = dd;
            });

            return { totalPnl, winRate, profitFactor, avgDailyProfit, maxDrawdown: maxDD * 100, totalTrades: trades.length };
        };

        // --- Components ---

        // 1. Stat Card (Fixed Layout for Matching Heights)
        const StatCard = ({ title, value, subValue, trend, chartData, items }) => {
            // List View (Bottom Right Card)
            if (items) {
                return (
                    <div className="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm hover:shadow-md transition-all h-full flex flex-col justify-center">
                        <div className="flex flex-col justify-center w-full">
                            {items.map((item, idx) => (
                                <div key={idx} className="flex justify-between items-center py-2 border-b border-slate-100 last:border-0 last:pb-0">
                                    <span className="text-slate-400 text-xs font-medium">{item.label}</span>
                                    <span className={`text-sm font-bold ${item.highlight ? 'text-slate-800' : 'text-slate-600'}`}>{item.value}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            // Chart View (Total Net P/L) - Equal Height Logic, Centered Content
            if (chartData) {
                // Determine colors based on trend/value (Green/Red)
                const isPositive = parseFloat(String(value).replace(/[^0-9.-]/g, '')) >= 0;
                const colorHex = isPositive ? CHART_GREEN : CHART_RED;
                const textColorClass = isPositive ? 'text-success-500' : 'text-danger-500';

                return (
                    <div className="bg-white border border-slate-200 rounded-2xl shadow-sm hover:shadow-md transition-all relative overflow-hidden h-full flex items-stretch">
                        <div className="flex flex-col justify-center z-10 flex-shrink-0 pl-6 py-4 pr-2">
                            <div className="flex items-center gap-2 mb-0.5">
                                <span className="text-slate-500 text-sm font-medium">{title}</span>
                                {trend === 'up' && <ArrowUpRight size={14} className="text-success-500" />}
                                {trend === 'down' && <ArrowDownRight size={14} className="text-danger-500" />}
                            </div>
                            <div className={`text-3xl font-bold tracking-tight ${textColorClass}`}>
                                {value}
                            </div>
                        </div>
                        <div className="flex-1 min-w-[100px] relative">
                            <div className="absolute inset-0 pt-4">
                                <ResponsiveContainer width="100%" height="100%">
                                    <AreaChart data={chartData}>
                                        <defs>
                                            <linearGradient id={`colorGradient-${isPositive?'pos':'neg'}`} x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor={colorHex} stopOpacity={0.2}/>
                                                <stop offset="95%" stopColor={colorHex} stopOpacity={0}/>
                                            </linearGradient>
                                        </defs>
                                        <Area type="monotone" dataKey="value" stroke={colorHex} strokeWidth={2} fillOpacity={1} fill={`url(#colorGradient-${isPositive?'pos':'neg'})`} isAnimationActive={false} />
                                    </AreaChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>
                );
            }
            return null;
        };

        // 2. Win Rate Widget - 60/40 Split & Colors
        const WinRateWidget = ({ trades }) => {
            const wins = trades.filter(t => t.pnl > 0).length;
            const losses = trades.filter(t => t.pnl < 0).length;
            const total = trades.length;
            const winRate = total > 0 ? (wins / total) * 100 : 0;

            const data = [
                { name: 'Win', value: wins, color: CHART_GREEN },
                { name: 'Loss', value: losses, color: CHART_RED },
            ];
            if (total === 0) { data[0].value = 0; data[1].value = 1; data[1].color = '#e2e8f0'; }

            return (
                <div className="bg-white border border-slate-200 rounded-2xl shadow-sm hover:shadow-md transition-all flex items-center h-full relative p-0 overflow-hidden">
                    
                    {/* 60% Chart Area - Centered */}
                    <div className="w-[60%] h-full flex items-center justify-center relative">
                        <div className="w-full h-[130px]">
                             <ResponsiveContainer width="100%" height="100%">
                                <PieChart>
                                    <Pie data={data} cx="50%" cy="50%" startAngle={180} endAngle={0} innerRadius={60} outerRadius={85} paddingAngle={0} dataKey="value" stroke="none">
                                        {data.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.color} />)}
                                    </Pie>
                                </PieChart>
                            </ResponsiveContainer>
                            <div className="absolute inset-0 flex flex-col items-center justify-center pt-6 pointer-events-none">
                                <span className="text-2xl font-bold text-slate-800 leading-none">{Math.round(winRate)}<span className="text-sm">%</span></span>
                            </div>
                        </div>
                    </div>

                    {/* 40% Legend Area - Centered Vertically */}
                    <div className="w-[40%] h-full flex flex-col justify-center gap-3 border-l border-slate-50 px-4 bg-slate-50/30">
                        <div className="flex flex-col gap-1">
                           <span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Wins</span>
                           <div className="flex items-center gap-2">
                               <div className="px-2.5 py-1 rounded-md font-bold text-sm shadow-sm bg-success-100 text-success-700 border border-success-100">
                                   {wins}
                               </div>
                           </div>
                        </div>
                        <div className="flex flex-col gap-1">
                           <span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Losses</span>
                           <div className="flex items-center gap-2">
                               <div className="px-2.5 py-1 rounded-md font-bold text-sm shadow-sm bg-danger-100 text-danger-700 border border-danger-100">
                                   {losses}
                               </div>
                           </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Calendar - Font Sizing Logic
        const Calendar = ({ trades, onDayClick }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            const getDayStats = (dateStr) => {
                const dayTrades = trades.filter(t => t.date === dateStr);
                return {
                    pnl: dayTrades.reduce((sum, t) => sum + t.pnl, 0),
                    percent: dayTrades.reduce((sum, t) => sum + t.pnlPercent, 0),
                    count: dayTrades.length
                };
            };

            const renderWeeks = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1, 12, 0, 0, 0);
                const startDay = firstDay.getDay(); 
                const daysFromMon = startDay === 0 ? 6 : startDay - 1;
                const start = new Date(firstDay);
                start.setDate(start.getDate() - daysFromMon);
                
                const weeks = [];
                let current = new Date(start);
                
                for(let w=0; w<6; w++) {
                    const weekDays = [];
                    let weekPnl = 0;
                    let weekPercent = 0;
                    let weekCount = 0;
                    let hasDaysInMonth = false;

                    for(let d=0; d<7; d++) {
                        const y = current.getFullYear();
                        const m = String(current.getMonth()+1).padStart(2,'0');
                        const dayNum = String(current.getDate()).padStart(2,'0');
                        const dateStr = `${y}-${m}-${dayNum}`;

                        const stats = getDayStats(dateStr);
                        const isCurrentMonth = current.getMonth() === month;
                        if(isCurrentMonth) hasDaysInMonth = true;

                        weekPnl += stats.pnl;
                        weekPercent += stats.percent;
                        weekCount += stats.count;

                        if(d < 5) weekDays.push({ date: dateStr, dayNum: current.getDate(), isCurrentMonth, stats });
                        current.setDate(current.getDate() + 1);
                    }
                    if(hasDaysInMonth || weeks.length === 0) {
                        weeks.push({ days: weekDays, summary: { pnl: weekPnl, percent: weekPercent, count: weekCount } });
                    } else { break; }
                }
                return weeks;
            };

            const weeks = renderWeeks();
            const todayObj = new Date();
            const todayStr = `${todayObj.getFullYear()}-${String(todayObj.getMonth()+1).padStart(2,'0')}-${String(todayObj.getDate()).padStart(2,'0')}`;

            return (
                <div className="bg-white border border-slate-200 rounded-3xl p-6 shadow-sm">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold text-slate-800">Calendar Performance</h2>
                        <div className="flex items-center gap-4 bg-slate-50 p-1 rounded-xl border border-slate-200">
                            <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1, 1))} className="p-2 hover:bg-white rounded-lg text-slate-400 hover:text-slate-600"><ChevronLeft size={20}/></button>
                            <span className="text-sm font-semibold text-slate-700 uppercase w-32 text-center">{monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}</span>
                            <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 1))} className="p-2 hover:bg-white rounded-lg text-slate-400 hover:text-slate-600"><ChevronRight size={20}/></button>
                        </div>
                    </div>
                    <div className="grid grid-cols-6 gap-2 mb-2">
                        {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Wk'].map((d, i) => (
                            <div key={i} className={`text-xs font-bold text-slate-400 uppercase text-center py-2 ${i===5?'bg-slate-50 rounded-lg':''}`}>{d}</div>
                        ))}
                    </div>
                    <div className="space-y-2">
                        {weeks.map((week, wIdx) => (
                            <div key={wIdx} className="grid grid-cols-6 gap-2">
                                {week.days.map((day, dIdx) => {
                                    let bg = "bg-slate-50/50 border-slate-100 hover:bg-white hover:shadow-md";
                                    let txt = "text-slate-400";
                                    // Using custom style for background opacity to match chart colors exact shade
                                    let customStyle = {};

                                    if(day.stats.count > 0) {
                                        if(day.stats.pnl > 0) { 
                                            // Green Background
                                            customStyle = { backgroundColor: `${CHART_GREEN}1A`, borderColor: `${CHART_GREEN}33` };
                                            txt = "text-success-500"; 
                                        } else if(day.stats.pnl < 0) { 
                                            // Red Background
                                            customStyle = { backgroundColor: `${CHART_RED}1A`, borderColor: `${CHART_RED}33` };
                                            txt = "text-danger-500"; 
                                        } else { 
                                            bg = "bg-white border-slate-200"; txt = "text-slate-600"; 
                                        }
                                    }
                                    const isToday = day.date === todayStr;
                                    
                                    // Dynamic font size logic - Robust shrink to fit
                                    const pnlStr = day.stats.pnl.toLocaleString('en-US', {style:'currency', currency:'USD', minimumFractionDigits:0});
                                    const charCount = pnlStr.length;
                                    let pnlSize = "text-sm"; 
                                    if(charCount > 8) pnlSize = "text-[9px]"; 
                                    else if(charCount > 6) pnlSize = "text-[10px]";
                                    else if(charCount > 5) pnlSize = "text-xs";
                                    else pnlSize = "text-sm md:text-base";
                                    
                                    return (
                                        <div key={dIdx} onClick={() => onDayClick(day.date)} 
                                            style={Object.keys(customStyle).length ? customStyle : {}}
                                            className={`min-h-[80px] border rounded-xl p-2 flex flex-col justify-between cursor-pointer transition-all relative overflow-hidden ${bg} ${isToday ? 'ring-2 ring-primary-500':''} ${!day.isCurrentMonth?'opacity-40':''}`}>
                                            <div className="flex justify-between"><span className={`text-xs font-semibold ${isToday ? 'text-primary-600':'text-slate-500'}`}>{day.dayNum}</span></div>
                                            <div className="text-right w-full flex flex-col items-end">
                                                {day.stats.count > 0 ? (
                                                    <>
                                                        <div className={`${pnlSize} font-bold leading-tight whitespace-nowrap ${txt}`}>{day.stats.pnl>0?'+':''}{pnlStr}</div>
                                                        <div className={`text-[9px] font-medium leading-tight ${day.stats.percent>0?'text-success-500':'text-danger-500'}`}>{day.stats.percent>0?'+':''}{day.stats.percent.toFixed(1)}%</div>
                                                    </>
                                                ) : <span className="text-slate-300">-</span>}
                                            </div>
                                        </div>
                                    );
                                })}
                                {/* Week Summary */}
                                <div className="min-h-[80px] bg-slate-100 border border-slate-200 rounded-xl p-2 flex flex-col justify-center items-end">
                                    <span className={`text-xs font-bold whitespace-nowrap ${week.summary.pnl>=0?'text-success-500':'text-danger-500'}`}>{week.summary.pnl>0?'+':''}${Math.round(week.summary.pnl).toLocaleString()}</span>
                                    <span className={`text-[9px] whitespace-nowrap ${week.summary.percent>=0?'text-success-500':'text-danger-500'}`}>{week.summary.percent>0?'+':''}{week.summary.percent.toFixed(1)}%</span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // 4. Trade List - Fixed Height, Compact, No Strategy, Uniform Colors
        const TradeList = ({ trades, onEdit, onDelete, onAdd }) => {
            const sorted = [...trades].sort((a, b) => b.timestamp - a.timestamp);
            // Fixed height for approximately 5 rows + header
            return (
                <div className="bg-white border border-slate-200 rounded-3xl shadow-sm overflow-hidden flex flex-col h-[320px]">
                    <div className="p-4 border-b border-slate-100 flex justify-between items-center shrink-0 bg-white">
                        <h2 className="text-lg font-bold text-slate-800">Trades Journal</h2>
                        <button onClick={onAdd} className="flex items-center gap-2 bg-slate-900 text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow-sm"><Plus size={14}/> Add Trade</button>
                    </div>
                    <div className="overflow-y-auto custom-scrollbar flex-1">
                        <table className="w-full text-left text-sm text-slate-600 relative">
                            <thead className="bg-slate-50 text-[10px] uppercase font-bold text-slate-400 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th className="px-6 py-3">Date / Time</th>
                                    <th className="px-6 py-3">Ticker</th>
                                    <th className="px-6 py-3">Dir</th>
                                    <th className="px-6 py-3 text-right">Net P/L</th>
                                    <th className="px-6 py-3 text-right">%</th>
                                    <th className="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {sorted.length === 0 ? <tr><td colSpan="6" className="text-center py-8 text-slate-400">No trades yet.</td></tr> : sorted.map(t => (
                                    <tr key={t.id} className="hover:bg-slate-50 transition-colors group">
                                        <td className="px-6 py-2">
                                            <div className="flex items-center gap-1 text-[11px] font-medium text-slate-500">
                                                <span className="text-slate-600">{t.date}</span>
                                                <span className="text-slate-300">|</span>
                                                <span className="font-mono text-slate-400">{t.time}</span>
                                            </div>
                                        </td>
                                        <td className="px-6 py-2 font-bold text-slate-800 text-xs">{t.ticker}</td>
                                        <td className="px-6 py-2">
                                            {/* Consistent Colors */}
                                            <span className={`px-2 py-0.5 rounded text-[10px] font-bold border ${t.direction === 'Long' ? 'bg-success-50 text-success-500 border-success-100' : 'bg-danger-50 text-danger-500 border-danger-100'}`}>{t.direction}</span>
                                        </td>
                                        <td className={`px-6 py-2 text-right font-medium text-sm ${t.pnl>0?'text-success-500':t.pnl<0?'text-danger-500':'text-slate-600'}`}>
                                            {t.pnl>0?'+':''}{t.pnl.toLocaleString('en-US',{style:'currency',currency:'USD'})}
                                        </td>
                                        <td className={`px-6 py-2 text-right font-medium text-sm ${t.pnlPercent>0?'text-success-500':t.pnlPercent<0?'text-danger-500':'text-slate-500'}`}>
                                            {t.pnlPercent>0?'+':''}{t.pnlPercent.toFixed(2)}%
                                        </td>
                                        <td className="px-6 py-2 text-right">
                                            <div className="flex justify-end gap-1">
                                                <button onClick={()=>onEdit(t)} className="p-1 rounded-md text-slate-400 hover:text-primary-600 hover:bg-slate-100"><Pencil size={14}/></button>
                                                <button onClick={()=>onDelete(t.id)} className="p-1 rounded-md text-slate-400 hover:text-danger-500 hover:bg-slate-100"><Trash2 size={14}/></button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // 5. Reports (Weekly)
        const WeeklyPerformance = ({ trades }) => {
            if(trades.length === 0) return null;
            const getMonday = (d) => {
                const date = new Date(d);
                const day = date.getDay();
                const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                const m = new Date(date.setDate(diff));
                m.setHours(0,0,0,0);
                return m;
            };
            const weeksMap = {};
            trades.forEach(t => {
                const m = getMonday(new Date(t.date.replace(/-/g, '/')));
                const key = m.getTime();
                if(!weeksMap[key]) weeksMap[key] = [];
                weeksMap[key].push(t);
            });
            const sortedWeeks = Object.keys(weeksMap).sort((a,b) => b-a).map(k => {
                const weekTrades = weeksMap[k];
                const monday = new Date(parseInt(k));
                const days = [];
                const curr = new Date(monday);
                for(let i=0; i<5; i++) {
                    const y = curr.getFullYear();
                    const m = String(curr.getMonth()+1).padStart(2,'0');
                    const d = String(curr.getDate()).padStart(2,'0');
                    const dateStr = `${y}-${m}-${d}`;
                    const dTrades = weekTrades.filter(t => t.date === dateStr);
                    const pnl = dTrades.reduce((s,t)=>s+t.pnl,0);
                    const percent = dTrades.reduce((s,t)=>s+t.pnlPercent,0);
                    days.push({ display: curr.toLocaleDateString('en-US',{month:'short',day:'numeric'}), pnl, percent, count: dTrades.length });
                    curr.setDate(curr.getDate()+1);
                }
                const wPnl = weekTrades.reduce((s,t)=>s+t.pnl,0);
                const wPct = weekTrades.reduce((s,t)=>s+t.pnlPercent,0);
                return { days, summary: { pnl: wPnl, percent: wPct } };
            });

            return (
                <div className="bg-white border border-slate-200 rounded-3xl shadow-sm p-6 mt-8">
                    <h2 className="text-xl font-bold text-slate-800 mb-4">Weekly Performance</h2>
                    <div className="grid grid-cols-6 gap-2 mb-2">
                        {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Week'].map((d,i) => <div key={i} className="text-xs font-bold text-center text-slate-400 uppercase">{d}</div>)}
                    </div>
                    <div className="space-y-2">
                        {sortedWeeks.map((wk, i) => (
                            <div key={i} className="grid grid-cols-6 gap-2">
                                {wk.days.map((d, j) => {
                                    let color = d.pnl > 0 ? 'text-success-500' : d.pnl < 0 ? 'text-danger-500' : 'text-slate-400';
                                    let bg = "bg-slate-50/50 border-slate-100";
                                    let style = {};
                                    
                                    if(d.count > 0) {
                                        if(d.pnl > 0) {
                                            style = { backgroundColor: `${CHART_GREEN}1A`, borderColor: `${CHART_GREEN}33` };
                                            bg = "border";
                                        } else if(d.pnl < 0) {
                                            style = { backgroundColor: `${CHART_RED}1A`, borderColor: `${CHART_RED}33` };
                                            bg = "border";
                                        } else {
                                            bg = "bg-white border-slate-200";
                                        }
                                    }
                                    
                                    return (
                                        <div key={j} style={style} className={`border rounded-xl p-2 flex flex-col justify-between h-[70px] ${bg}`}>
                                            <span className="text-[9px] text-slate-400 font-semibold">{d.display}</span>
                                            {d.count > 0 ? (
                                                <div className="text-right">
                                                    <div className={`text-sm font-bold leading-none ${color}`}>{d.pnl>0?'+':''}{Math.round(d.pnl)}</div>
                                                </div>
                                            ) : <div className="text-right text-slate-300">-</div>}
                                        </div>
                                    );
                                })}
                                <div className="bg-slate-100 border border-slate-200 rounded-xl p-2 flex flex-col justify-center items-end h-[70px]">
                                    <span className={`text-sm font-bold ${wk.summary.pnl >= 0 ? 'text-success-500' : 'text-danger-500'}`}>
                                        {wk.summary.pnl > 0 ? '+' : wk.summary.pnl < 0 ? '-' : ''}${Math.abs(Math.round(wk.summary.pnl))}
                                    </span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const AddTradeModal = ({ isOpen, onClose, onSave, onDelete, initialDate, tradeToEdit }) => {
            const [formData, setFormData] = useState({ id: '', timestamp: 0, date: '', time: '', direction: 'Long', status: 'Win', pnl: '', pnlPercent: 0, accountBalance: 10000, ticker: 'XAUUSD', setup: '', notes: '' });
            
            useEffect(() => {
                if(isOpen) {
                    if(tradeToEdit) {
                        let bal = 10000;
                        if(tradeToEdit.pnlPercent !== 0) bal = (tradeToEdit.pnl / tradeToEdit.pnlPercent) * 100;
                        setFormData({ ...tradeToEdit, accountBalance: Math.abs(bal) });
                    } else {
                        const d = new Date();
                        const todayStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                        setFormData({ id: '', timestamp: 0, date: initialDate || todayStr, time: d.toTimeString().slice(0,5), direction: 'Long', status: 'Win', pnl: '', pnlPercent: 0, accountBalance: 10000, ticker: 'XAUUSD', setup: '', notes: '' });
                    }
                }
            }, [isOpen, tradeToEdit, initialDate]);

            useEffect(() => {
                const pnl = Number(formData.pnl || 0);
                const bal = Number(formData.accountBalance);
                if(bal !== 0) setFormData(prev => ({ ...prev, pnlPercent: (pnl/bal)*100 }));
            }, [formData.pnl, formData.accountBalance]);

            if(!isOpen) return null;
            const handleSubmit = (e) => {
                e.preventDefault();
                const pnlVal = Number(formData.pnl);
                const newTrade = { ...formData, id: tradeToEdit ? tradeToEdit.id : Math.random().toString(36).substr(2,9), timestamp: new Date(formData.date + 'T' + formData.time).getTime(), pnl: pnlVal, pnlPercent: Number(formData.pnlPercent), status: pnlVal > 0 ? 'Win' : pnlVal < 0 ? 'Loss' : 'Break Even' };
                onSave(newTrade);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-slate-900/20 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-white border border-slate-200 rounded-3xl w-full max-w-lg shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold">{tradeToEdit ? 'Edit Trade' : 'New Trade'}</h2>
                            <button onClick={onClose}><X size={24} className="text-slate-400"/></button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs font-bold text-slate-500 block mb-1">Date</label><input required type="date" value={formData.date} onChange={e=>setFormData({...formData, date:e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200"/></div>
                                <div><label className="text-xs font-bold text-slate-500 block mb-1">Time</label><input required type="time" value={formData.time} onChange={e=>setFormData({...formData, time:e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200"/></div>
                            </div>
                            <div><label className="text-xs font-bold text-slate-500 block mb-1">Ticker</label><input required value={formData.ticker} onChange={e=>setFormData({...formData, ticker:e.target.value.toUpperCase()})} className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 font-bold"/></div>
                            <div className="grid grid-cols-2 gap-4">
                                <button type="button" onClick={()=>setFormData({...formData, direction:'Long'})} className={`p-3 rounded-xl font-bold border ${formData.direction==='Long'?'bg-success-500 text-white border-success-500':'bg-slate-50 text-slate-500 border-slate-200'}`}>Buy / Long</button>
                                <button type="button" onClick={()=>setFormData({...formData, direction:'Short'})} className={`p-3 rounded-xl font-bold border ${formData.direction==='Short'?'bg-danger-500 text-white border-danger-500':'bg-slate-50 text-slate-500 border-slate-200'}`}>Sell / Short</button>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 block mb-1">Net P/L ($)</label>
                                <div className="relative">
                                    <input required type="number" step="any" value={formData.pnl} onChange={e=>setFormData({...formData, pnl:e.target.value})} className={`w-full p-3 bg-slate-50 rounded-xl border border-slate-200 font-bold ${Number(formData.pnl)>0?'text-success-500':Number(formData.pnl)<0?'text-danger-500':'text-slate-800'}`}/>
                                    <span className={`absolute right-4 top-3 text-sm font-bold ${formData.pnlPercent>0?'text-success-500':formData.pnlPercent<0?'text-danger-500':'text-slate-400'}`}>{formData.pnlPercent>0?'+':''}{formData.pnlPercent.toFixed(2)}%</span>
                                </div>
                            </div>
                            <div><label className="text-xs font-bold text-slate-500 block mb-1">Balance ($)</label><input type="number" value={formData.accountBalance} onChange={e=>setFormData({...formData, accountBalance:e.target.value})} className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200"/></div>
                            <div className="pt-4 flex gap-3">
                                {tradeToEdit && <button type="button" onClick={()=>{ if(window.confirm('Delete?')) { onDelete(tradeToEdit.id); onClose(); }}} className="flex-1 bg-danger-50 text-danger-500 p-3 rounded-xl font-bold">Delete</button>}
                                <button type="submit" className="flex-1 bg-slate-900 text-white p-3 rounded-xl font-bold shadow-lg">Save Trade</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [trades, setTrades] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editTrade, setEditTrade] = useState(null);
            const [modalDate, setModalDate] = useState(undefined);

            useEffect(() => { setTrades(loadTrades()); }, []);
            useEffect(() => { if(trades.length > 0 || loadTrades().length > 0) saveTrades(trades); }, [trades]);

            const stats = useMemo(() => calculateStats(trades), [trades]);
            const chartData = useMemo(() => {
                const sorted = [...trades].sort((a,b) => a.timestamp - b.timestamp);
                let run = 0;
                return sorted.map(t => { run += t.pnl; return { value: run }; });
            }, [trades]);

            const handleSave = (trade) => {
                setTrades(prev => {
                    const idx = prev.findIndex(t => t.id === trade.id);
                    if(idx >= 0) { const n = [...prev]; n[idx] = trade; return n; }
                    return [...prev, trade];
                });
            };
            const handleDelete = (id) => setTrades(prev => prev.filter(t => t.id !== id));
            
            // Last 5 logic using consistent colors
            const last5 = [...trades].sort((a,b)=>b.timestamp-a.timestamp).slice(0,5).reverse();

            return (
                <div className="min-h-screen pb-12">
                    <div className="max-w-7xl mx-auto p-4 md:p-8 space-y-6">
                        <div className="flex items-center justify-center mb-4">
                            <div className="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center shadow-lg shadow-primary-600/20 mr-3">
                                <span className="text-white font-bold text-xl">Z</span>
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800 tracking-tight">TradeJournal Pro</h1>
                        </div>

                        {/* KPI Grid - Set fixed height (approx 180px) for top 2 cards, keep list auto */}
                        <div className="grid grid-cols-1 lg:grid-cols-[30fr_40fr_30fr] gap-4">
                            <div className="h-[180px]">
                                <StatCard 
                                    title="Total Net P/L" 
                                    value={`$${stats.totalPnl.toLocaleString()}`}
                                    chartData={chartData}
                                />
                            </div>
                            <div className="h-[180px]">
                                <WinRateWidget trades={trades} />
                            </div>
                            {/* Third card (List) adapts height or can be fixed, 180px matches others well */}
                            <div className="h-[180px]">
                                <StatCard 
                                    items={[
                                        { label: 'Profit Factor', value: stats.profitFactor.toFixed(2), highlight: true },
                                        { label: 'Avg Daily', value: `$${Math.round(stats.avgDailyProfit)}` },
                                        { label: 'Max Drawdown', value: `${stats.maxDrawdown.toFixed(1)}%` },
                                        { label: 'Last 5', value: (
                                            <div className="flex gap-1">
                                                {last5.map(t => (
                                                    <span key={t.id} className={`w-5 h-5 flex items-center justify-center rounded text-[10px] font-bold ${t.pnl > 0 ? 'bg-success-100 text-success-700' : t.pnl < 0 ? 'bg-danger-100 text-danger-700' : 'bg-slate-400 text-white'}`}>
                                                        {t.pnl>0?'W':t.pnl<0?'L':'B'}
                                                    </span>
                                                ))}
                                            </div>
                                        )}
                                    ]}
                                />
                            </div>
                        </div>

                        <Calendar 
                            trades={trades} 
                            onDayClick={(d) => { setModalDate(d); setEditTrade(null); setIsModalOpen(true); }} 
                        />

                        <TradeList 
                            trades={trades}
                            onAdd={() => { setModalDate(undefined); setEditTrade(null); setIsModalOpen(true); }}
                            onEdit={(t) => { setEditTrade(t); setIsModalOpen(true); }}
                            onDelete={handleDelete}
                        />

                        <WeeklyPerformance trades={trades} />
                    </div>

                    <AddTradeModal 
                        isOpen={isModalOpen}
                        onClose={() => setIsModalOpen(false)}
                        onSave={handleSave}
                        onDelete={handleDelete}
                        initialDate={modalDate}
                        tradeToEdit={editTrade}
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>